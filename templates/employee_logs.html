{% extends "base_page.html" %}

{% block title %}Working Hours Analysis{% endblock %}

{% block page_title %}Working Hours Analysis (In/Out Time){% endblock %}

{% block content %}
<div class="card-large">
    <p>The total time employees spent inside and outside, according to turnstile movements over the selected date range, is listed. Matching is done based on First Name and Last Name.</p>

    <div class="filter-controls">
        <form id="filter-form" method="GET" action="{{ url_for('employee_logs') }}" class="filter-form-inline">
            <div class="searchable-dropdown">
                <label for="employee_search">Select Employee:</label>
                <div class="search-input-container">
                    <input type="text"
                           id="employee_search"
                           name="employee_search"
                           placeholder="Type to search employees..."
                           autocomplete="off"
                           value="{{ selected_employee_name if selected_person_key else (request.args.get('employee_search') or '') }}"
                           class="search-input">

                    <input type="hidden" id="person_key" name="person_key" value="{{ selected_person_key or '' }}">

                    <div id="search_results" class="search-results"></div>
                </div>
            </div>

            <div class="form-group-flex">
                <div>
                    <label for="start_date">Start Date:</label>
                    <input type="date"
                           id="start_date"
                           name="start_date"
                           value="{{ start_date or '' }}"
                           class="form-input">
                </div>

                <div>
                    <label for="end_date">End Date:</label>
                    <input type="date"
                           id="end_date"
                           name="end_date"
                           value="{{ end_date or '' }}"
                           class="form-input">
                </div>
            </div>

            <button type="submit" class="apply-filter-button">
                Filter
            </button>

            <a id="export-link"
               href="{{ url_for('export_employee_logs', person_key=selected_person_key or '') }}"
               class="export-button">
                <i class="fas fa-file-export"></i> Export to CSV
            </a>
        </form>
    </div>

    {% if start_date and end_date %}
    <div class="date-range-info">
        <strong>Date Range:</strong> {{ start_date }} to {{ end_date }}
    </div>
    {% endif %}

    <h3 class="section-title">
        Summary Table: {{ selected_employee_name }}
        {% if start_date and end_date %}
        <span class="date-range">({{ start_date }} to {{ end_date }})</span>
        {% endif %}
    </h3>

    <div class="logs-container">
        {% if logs %}
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Employee Name</th>
                    <th>First In</th>
                    <th>Last Out</th>
                    <th>Total INSIDE Time</th>
                    <th>Total OUTSIDE Time</th>
                    <th>Total Time (Span)</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr class="clickable-row">
                    <td>{{ log.date }}</td>
                    <td class="employee-name-cell"
                        data-employee-name="{{ log.name }} {{ log.last_name }}">
                        {{ log.name }} {{ log.last_name }}
                    </td>
                    <td>{{ log.first_in }}</td>
                    <td>
                        {% if log.is_invalid_day %}
                            <span class="na-text">N/A</span>
                        {% elif log.is_currently_inside %}
                            <span class="inside-text">Still Inside</span>
                        {% else %}
                            {{ log.last_out }}
                        {% endif %}
                    </td>
                    <td class="time-value">
                        {{ log.inside_time }}
                    </td>
                    <td class="time-value">
                        {{ log.outside_time }}
                    </td>
                    <td class="time-value">
                        {% if log.is_invalid_day %}
                            N/A
                        {% elif log.total_span_seconds and log.total_span_seconds > 0 %}
                            {{ format_seconds(log.total_span_seconds) }}
                        {% else %}
                            00:00:00
                        {% endif %}
                    </td>
                    <td>
                        <span class="status-text" style="color: {{ log.status_color }};">
                            {{ log.status_display }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="no-data">No movement data found for the selected employee/time period (Matching Error possible).</p>
        {% endif %}
    </div>
</div>

<script>
    // Global değişkenler
    let searchInput, personKeyInput, searchResults, exportLink, startDateInput, endDateInput;
    let currentResults = [];
    let selectedIndex = -1;

    function goToEmployees(employeeName) {
        window.location.href = "{{ url_for('employees') }}?employee_search=" + encodeURIComponent(employeeName);
    }

    function performSearch(query) {
        if (query.length < 2) {
            if (searchResults) {
                searchResults.style.display = 'none';
            }
            return;
        }

        fetch(`/api/employee_search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                currentResults = data;
                selectedIndex = -1;

                if (data.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item">No employees found</div>';
                    searchResults.style.display = 'block';
                    return;
                }

                searchResults.innerHTML = data.map(emp =>
                    `<div class="search-result-item" data-key="${emp.key}" data-name="${emp.name}">${emp.name}</div>`
                ).join('');
                searchResults.style.display = 'block';
            })
            .catch(error => {
                console.error('Search error:', error);
                if (searchResults) {
                    searchResults.style.display = 'none';
                }
            });
    }

    function selectEmployee(key, name) {
        if (personKeyInput && searchInput) {
            personKeyInput.value = key;
            searchInput.value = name;
            if (searchResults) {
                searchResults.style.display = 'none';
            }
            updateExportLink();
        }
    }

    function updateExportLink() {
        if (!personKeyInput || !exportLink || !startDateInput || !endDateInput) return;

        const selectedKey = personKeyInput.value;
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;

        let exportUrl = "{{ url_for('export_employee_logs') }}";
        let params = [];

        if (selectedKey) {
            params.push(`person_key=${selectedKey}`);
        }
        if (startDate) {
            params.push(`start_date=${startDate}`);
        }
        if (endDate) {
            params.push(`end_date=${endDate}`);
        }

        if (params.length > 0) {
            exportUrl += '?' + params.join('&');
        }

        exportLink.href = exportUrl;
    }

    function updateSelectedItem() {
        if (!searchResults) return;

        const items = searchResults.querySelectorAll('.search-result-item');
        items.forEach((item, index) => {
            item.classList.toggle('active', index === selectedIndex);
        });

        if (selectedIndex >= 0 && currentResults[selectedIndex] && searchInput) {
            searchInput.value = currentResults[selectedIndex].name;
        }
    }

    function handleSearchKeydown(e) {
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, currentResults.length - 1);
            updateSelectedItem();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, -1);
            updateSelectedItem();
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (selectedIndex >= 0 && currentResults[selectedIndex]) {
                selectEmployee(currentResults[selectedIndex].key, currentResults[selectedIndex].name);
            }
        }
    }

    function handleDocumentClick(e) {
        if (searchInput && !searchInput.contains(e.target) && searchResults && !searchResults.contains(e.target)) {
            searchResults.style.display = 'none';
        }
    }

    function handleSearchResultsClick(e) {
        if (e.target.classList.contains('search-result-item')) {
            const key = e.target.getAttribute('data-key');
            const name = e.target.getAttribute('data-name');
            selectEmployee(key, name);
        }
    }

    function initializeEmployeeSearch() {
        // Element referanslarını al
        searchInput = document.getElementById('employee_search');
        personKeyInput = document.getElementById('person_key');
        searchResults = document.getElementById('search_results');
        exportLink = document.getElementById('export-link');
        startDateInput = document.getElementById('start_date');
        endDateInput = document.getElementById('end_date');

        // Eğer elementler bulunamazsa çık
        if (!searchInput || !personKeyInput || !searchResults || !exportLink || !startDateInput || !endDateInput) {
            console.error('Required elements not found');
            return;
        }

        // Event listener'ları ekle
        document.querySelectorAll('.employee-name-cell').forEach(cell => {
            cell.addEventListener('click', function(e) {
                e.stopPropagation();
                const employeeName = this.getAttribute('data-employee-name');
                goToEmployees(employeeName);
            });
        });

        document.querySelectorAll('.clickable-row').forEach(row => {
            row.addEventListener('click', function(e) {
                if (!e.target.classList.contains('employee-name-cell') && !e.target.closest('.employee-name-cell')) {
                    const employeeNameCell = this.querySelector('.employee-name-cell');
                    if (employeeNameCell) {
                        const employeeName = employeeNameCell.getAttribute('data-employee-name');
                        goToEmployees(employeeName);
                    }
                }
            });
        });

        searchInput.addEventListener('input', function(e) {
            performSearch(e.target.value);
        });

        searchInput.addEventListener('focus', function() {
            if (currentResults.length > 0) {
                searchResults.style.display = 'block';
            }
        });

        searchInput.addEventListener('keydown', handleSearchKeydown);
        startDateInput.addEventListener('change', updateExportLink);
        endDateInput.addEventListener('change', updateExportLink);
        document.addEventListener('click', handleDocumentClick);
        searchResults.addEventListener('click', handleSearchResultsClick);

        // URL'den employee_search parametresini kontrol et
        const urlParams = new URLSearchParams(window.location.search);
        const employeeSearch = urlParams.get('employee_search');
        if (employeeSearch && employeeSearch.trim() !== '') {
            searchInput.value = employeeSearch;
            performSearch(employeeSearch);

            setTimeout(() => {
                if (currentResults.length > 0) {
                    selectEmployee(currentResults[0].key, currentResults[0].name);
                }
            }, 100);
        }

        updateExportLink();
    }

    // DOM yüklendiğinde çalıştır
    document.addEventListener('DOMContentLoaded', initializeEmployeeSearch);
</script>
{% endblock %}