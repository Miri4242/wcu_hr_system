{% extends "base_page.html" %}

{% block title %}Employees{% endblock %}

{% block page_title %}Employee List{% endblock %}

{% block content %}
<div class="card-large">
    <div class="header-controls">
        <div class="header-title">
            <h3>All Employees</h3>
            <span class="employee-count">(<span id="employee-count">0</span> found)</span>
        </div>

        <div class="search-container" style="display: flex; align-items: center; gap: 10px;">
            <input type="text" id="employee-search" class="search-input" placeholder="Type to search employee" value="{{ request.args.get('search', '') }}">
            <span class="material-icons search-icon">search</span>
            <button id="search-button" class="action-button" style="padding: 8px 16px; min-width: auto;">
                <i class="fas fa-search"></i> Search
            </button>
        </div>

        <a href="{{ url_for('export_employees') }}" class="action-button export-button">
            <i class="fas fa-file-export"></i> Export to CSV
        </a>
    </div>

    <table class="employee-table" id="employees-table">
        <thead>
            <tr>
                <th>Employee</th>
                <th>Position</th>
                <th>Email</th>
                <th>Mobile</th>
            </tr>
        </thead>
        <tbody id="employees-tbody">
            <!-- İlk yüklemede boş tbody -->
            <tr>
                <td colspan="4" class="no-data">Please enter a search term to find employees.</td>
            </tr>
        </tbody>
    </table>

    <div id="no-results" class="no-results" style="display: none;">
        No employees found matching your search criteria.
    </div>

    <div id="loading-spinner" class="loading-spinner" style="display: none;">
        <div class="spinner"></div>
        <span>Loading employees...</span>
    </div>
</div>

<script>
    // Global değişkenler
    let allEmployees = [];
    let currentSearchTerm = '';

    // Azerbaycan harfleri için normalize fonksiyonu
    function normalizeAzerbaijani(text) {
        if (!text) return '';

        const replacements = {
            'ə': 'e',
            'ü': 'u',
            'ö': 'o',
            'ğ': 'g',
            'ş': 's',
            'ç': 'c',
            'ı': 'i',
            'Ə': 'E',
            'Ü': 'U',
            'Ö': 'O',
            'Ğ': 'G',
            'Ş': 'S',
            'Ç': 'C',
            'I': 'I'
        };

        return text.toLowerCase().replace(/[əüöğşçıƏÜÖĞŞÇI]/g, char => replacements[char] || char);
    }

    function openOutlookWeb(recipientEmail) {
        const outlookComposeUrl = `https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(recipientEmail)}`;
        window.open(outlookComposeUrl, '_blank');
    }

    function goToEmployeeLogs(employeeName) {
        window.location.href = "{{ url_for('employee_logs') }}?employee_search=" + encodeURIComponent(employeeName);
    }

    // Email kısaltma fonksiyonu
    function truncateEmail(email, maxLength = 35) {
        if (!email || email === 'N/A') return 'N/A';

        if (email.length <= maxLength) return email;

        return email.substring(0, maxLength) + '...';
    }

    // AJAX ile çalışanları getir
    function fetchEmployees(searchTerm = '') {
        const loadingSpinner = document.getElementById('loading-spinner');
        const tableBody = document.getElementById('employees-tbody');
        const noResults = document.getElementById('no-results');
        const employeeCount = document.getElementById('employee-count');

        loadingSpinner.style.display = 'flex';
        tableBody.style.display = 'none';
        noResults.style.display = 'none';

        fetch(`/api/employees_list?search=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(data => {
                allEmployees = data;
                displayEmployees(searchTerm);
                loadingSpinner.style.display = 'none';
            })
            .catch(error => {
                console.error('Error fetching employees:', error);
                loadingSpinner.style.display = 'none';
                tableBody.innerHTML = '<tr><td colspan="4" class="no-data">Error loading employees. Please try again.</td></tr>';
                tableBody.style.display = '';
                employeeCount.textContent = '0';
            });
    }

    // Çalışanları görüntüle
    function displayEmployees(searchTerm) {
        const tableBody = document.getElementById('employees-tbody');
        const noResults = document.getElementById('no-results');
        const employeeCount = document.getElementById('employee-count');

        // Arama terimini normalize et (Azerbaycan harfleri için)
        const searchTermNormalized = normalizeAzerbaijani(searchTerm).trim();

        let filteredEmployees = allEmployees;

        // Eğer arama terimi varsa filtrele
        if (searchTermNormalized) {
            filteredEmployees = allEmployees.filter(emp => {
                // Tüm alanları birleştir ve normalize et
                const searchData = normalizeAzerbaijani(
                    emp.name + ' ' +
                    emp.last_name + ' ' +
                    emp.position + ' ' +
                    emp.email + ' ' +
                    emp.mobile_phone
                );
                return searchData.includes(searchTermNormalized);
            });
        }

        // Sonuçları güncelle
        employeeCount.textContent = filteredEmployees.length;

        if (filteredEmployees.length === 0) {
            tableBody.style.display = 'none';
            noResults.style.display = 'block';
            return;
        }

        // Tabloyu doldur
        tableBody.innerHTML = '';
        filteredEmployees.forEach(employee => {
            const row = document.createElement('tr');
            row.className = 'employee-row clickable-row';
            row.setAttribute('data-employee-name', `${employee.name} ${employee.last_name}`);

            // Email link kontrolü ve kısaltma
            const emailCell = (employee.email && employee.email !== 'N/A') ?
                `<a href="#" onclick="openOutlookWeb('${employee.email}'); return false;" class="mail-link" title="Send email to ${employee.name} ${employee.last_name}">${truncateEmail(employee.email)}</a>` :
                'N/A';

            row.innerHTML = `
                <td class="employee-name-cell">
                    <img src="${employee.photo_path}" alt="${employee.name} Photo" class="employee-photo">
                    ${employee.name} ${employee.last_name}
                </td>
                <td class="employee-position">${employee.position}</td>
                <td>${emailCell}</td>
                <td class="employee-mobile">${employee.mobile_phone}</td>
            `;

            // Click event listener ekle
            row.addEventListener('click', function(e) {
                if (e.target.tagName === 'A' || e.target.closest('a')) {
                    return;
                }
                goToEmployeeLogs(`${employee.name} ${employee.last_name}`);
            });

            tableBody.appendChild(row);
        });

        tableBody.style.display = '';
        noResults.style.display = 'none';
    }

    // Arama işlemi
    function performSearch() {
        const searchInput = document.getElementById('employee-search');
        const searchTerm = searchInput.value;
        currentSearchTerm = searchTerm;

        const url = new URL(window.location);
        if (searchTerm) {
            url.searchParams.set('search', searchTerm);
        } else {
            url.searchParams.delete('search');
        }
        window.history.replaceState({}, '', url);

        if (allEmployees.length === 0 && searchTerm) {
            // İlk arama - verileri getir
            fetchEmployees(searchTerm);
        } else {
            // Mevcut verilerle filtrele
            displayEmployees(searchTerm);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('employee-search');
        const searchButton = document.getElementById('search-button');
        const tableBody = document.getElementById('employees-tbody');

        // URL'den search parametresini al ve otomatik arama yap
        const urlParams = new URLSearchParams(window.location.search);
        const searchParam = urlParams.get('search');

        if (searchParam && searchParam.trim() !== '') {
            searchInput.value = searchParam;
            // Arama yap ve sonuçları göster
            fetchEmployees(searchParam);
        } else {
            // Eğer search parametresi yoksa boş göster
            tableBody.innerHTML = '<tr><td colspan="4" class="no-data">Please enter a search term to find employees.</td></tr>';
            tableBody.style.display = '';
        }

        // Search butonu event listener
        searchButton.addEventListener('click', function() {
            performSearch();
        });

        // Enter tuşu için
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performSearch();
            }
        });

        // Sayfa yüklendiğinde arama kutusuna odaklan
        searchInput.focus();
    });
</script>

<style>
.loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    color: #666;
}

.spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.mail-link {
    display: inline-block;
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: bottom;
}

.search-container {
    display: flex;
    align-items: center;
    gap: 10px;
}

#search-button {
    padding: 8px 16px;
    min-width: auto;
    white-space: nowrap;
}
</style>
{% endblock %}